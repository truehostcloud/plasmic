// This is a skeleton starter React component generated by Plasmic.
// This file is owned by you, feel free to edit as you see fit.
import { useTokenControls } from "@/wab/client/components/sidebar/token-controls";
import PlasmicTokenTypeHeader, {
  DefaultTokenTypeHeaderProps,
} from "@/wab/client/plasmic/plasmic_kit_left_pane/PlasmicTokenTypeHeader";
import { useStudioCtx } from "@/wab/client/studio-ctx/StudioCtx";
import { TokenType, tokenTypeLabel } from "@/wab/commons/StyleToken";
import { spawn } from "@/wab/shared/common";
import { canCreateAlias } from "@/wab/shared/ui-config-utils";
import { MultiChoiceArg } from "@plasmicapp/react-web";
import * as React from "react";

interface TokenTypeHeaderProps extends DefaultTokenTypeHeaderProps {
  tokenType: TokenType;
  isExpanded?: boolean;
  toggleExpand: () => void;
}

const PREVIOUS_TOKEN_TYPES: Record<TokenType, TokenType> = {
  Color: TokenType.Color,
  FontFamily: TokenType.Color,
  FontSize: TokenType.FontFamily,
  LineHeight: TokenType.FontSize,
  Opacity: TokenType.LineHeight,
  Spacing: TokenType.Opacity,
};

function TokenTypeHeader(props: TokenTypeHeaderProps) {
  const { isExpanded, tokenType, toggleExpand, ...rest } = props;
  const studioCtx = useStudioCtx();
  const tokenControls = useTokenControls();

  React.useEffect(() => {
    tokenControls.setExpandedHeaders((set) => {
      if (isExpanded && !set.has(tokenType)) {
        set.add(tokenType);
      } else if (!isExpanded && set.has(tokenType)) {
        set.delete(tokenType);
      } else {
        return set;
      }

      return new Set(set);
    });
  }, [isExpanded]);

  const uiConfig = studioCtx.getCurrentUiConfig();
  const canCreateToken = canCreateAlias(uiConfig, "token");

  const readOnly =
    !canCreateToken || studioCtx.getLeftTabPermission("tokens") === "readable";

  const borders: MultiChoiceArg<"bottom" | "top"> = [
    "bottom" as const,
    ...(tokenType !== TokenType.Color &&
    tokenControls.expandedHeaders.has(PREVIOUS_TOKEN_TYPES[tokenType])
      ? ["top" as const]
      : []),
  ] as const;

  return (
    <PlasmicTokenTypeHeader
      tokenType={tokenTypeLabel(tokenType)}
      addButton={
        readOnly
          ? { render: () => null }
          : {
              props: {
                onClick: (e) => {
                  e.stopPropagation();
                  if (!isExpanded) {
                    toggleExpand();
                  }
                  spawn(tokenControls.onAdd(tokenType));
                },
              },
            }
      }
      isExpanded={isExpanded}
      border={borders}
      {...rest}
    />
  );
}

export default TokenTypeHeader;
